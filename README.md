Elide-Based Post and Commenting System
======================================

This is an [Elide-based](https://github.com/yahoo/elide) post and commenting system with real user authentication. While authentication is simple, this is intended to be an illustrative example of using Elide. It uses Elide standalone to create the service.

## Table of Contents

  * [Building and Running](#building)
  * [Explanation](#explain)
    * [Code Structure](#explain-structure)
    * [Where is the API?](#explain-api)
    * [User Authentication](#explain-auth)
    * [Security](#explain-security)
  * [Using the Service Web API](#using)
    * [Create a User](#using-user)
    * [Create a Post](#using-post)
    * [Create a Comment](#using-comment)
  
## <a name="building"></a>Building and Running

Building this application only requires **one** step. It will build a completely self-contained application jar.

```
$ ./gradlew build
```

Before running the application, please be sure your MySQL database is setup properly. The application's default settings assume you have a MySQL server running with the following settings:

<table>
<thead>
  <tr><th>Setting</th><th>Value</th></tr>
</thead>
<tr><td>Host</td><td>localhost</td></tr>
<tr><td>Port</td><td>3306</td></tr>
<tr><td>Database</td><td>elide</td></tr>
<tr><td>User</td><td>elide</td></tr>
<tr><td>Password</td><td>elide123</td></tr>
</table>

If you wish to change these settings, then please modify the [hibernate.cfg.xml](./settings/hibernate.cfg.xml).

After your MySQL database is up and running, run:

```
$ java -jar build/libs/sample-app-1.0-SNAPSHOT-all.jar
```

Your application is now started and your web service should now be running on port `5050`.

## <a name="explain"></a>Explanation

This sample application applies principles useful in building real world apps. Namely, it provides a mechanism for performing real database-backed security as well as usage of finely tuned security rules.

### <a name="explain-structure"></a>Code Structure

The code is outlined as follows:

```
src/main/kotlin/com/dennismcwherter/elide/app
├── filters
│   └── UserAuthFilter.kt
├── models
│   ├── Account.kt
│   ├── Comment.kt
│   ├── Post.kt
│   └── package-info.java
└── security
    ├── Settings.kt
    ├── checks
    │   ├── AccountChecks.kt
    │   ├── OwnedEntityChecks.kt
    │   └── UserChecks.kt
    ├── context
    │   ├── AccountPrincipal.kt
    │   └── ApplicationSecurityContext.kt
    └── interfaces
        └── OwnedEntity.kt
```

A brief explanation of the directories is below:

<table>
<thead>
  <tr><th>Directory</th><th>Description</th></tr>
</thead>
<tr><td>filters</td><td>Contains JAX-RS/Jersey web filters</td></tr>
<tr><td>models</td><td>Contains JPA annotated API models</td></tr>
<tr><td>security</td><td>Contains all security related code</td></tr>
<tr><td>security/checks</td><td>Contains all security check implementations</td></tr>
<tr><td>security/context</td><td>Holds JAX-RS security context information</td></tr>
<tr><td>security/interfaces</td><td>Holds common security check interfaces</td></tr>
</table>

### <a name="explain-api"></a>Where is the API?

The API is generated by [http://elide.io](Elide) using the models found in the models package. For more information about how Elide works, please visit [Elide's homepage](http://elide.io).

### <a name="explain-auth"></a>User Authentication

User authentication is performed in the `UserAuthFilter`. While Elide can properly `authorize` users, it does not handle `authentication` out of box. As a result, we use a simple web filter to parse the `User` and `Password` headers and determine whether or not proper credentials were provided.

While there are more complex schemes to handle authentication (i.e. microservices via oauth, tokens, etc.) this is a real mechanism that could be used. However, it is likely one would want to make some slight modifications to pass secure, revokable credentials (i.e. tokens) rather than constantly sending the username and password with each request.

### <a name="explain-security"></a>Security

Security rule implementations are broken out into the `security/checks` directory. The idea is that these are single units of computation that can then be combined in our expressions to maximize check re-usability.
 
We have examples of these checks operating on data as well as user principal objects.
 
## <a name="using"></a>Using the Web API

#### GraphQL

The GraphQL-based API has a single endpoint:

`/graphql/api/v1`

You can use one of 2 top-level (i.e. rootable) objects to manipulate this API:

<table>
<thead>
  <tr><th>Object</th><th>Description</th></tr>
</thead>
<tr><td>account</td><td>Used for all account actions. Can return current user account info.</td></tr>
<tr><td>post</td><td>Used for all post actions. Contains all posts.</td></tr>
</table>

Additionally, over HTTP we use the `json` format to send our request. Similarly, we support additional headers for login. See below for an outlined list:

<table>
<thead>
  <tr><th>Header</th><th>Value</th></tr>
</thead>
<tr><td>Content-Type</td><td>application/json</td></tr>
<tr><td>Accept</td><td>application/json</td></tr>
<tr><td>User<strong>*</strong></td><td>&lt;your username&gt;</td></tr>
<tr><td>Password<strong>*</strong></td><td>&lt;your password&gt;</td></tr>
</table>

__* Only required if performing an action as logged in user__

#### JSON-API

The JSON-API-based API supports 2 top-level (i.e. rootable) endpoints:

<table>
<thead>
  <tr><th>Endpoint</th><th>Description</th></tr>
</thead>
<tr><td>/account</td><td>Used for all account actions. Can return current user account info.</td></tr>
<tr><td>/post</td><td>Used for all post actions. Contains all posts.</td></tr>
</table>

The `/account` endpoint can be hit by any user (though only if you are logged in will you see your information); it's also how accounts are created.

The `/post` endpoint can be _read_ by any user, but can only be updated by logged in users.

If you've looked through the code you will notice that we also have a `Comment` entity. This entity is **not** rootable and, therefore, cannot be accessed via `/comments`. However, with similar access permissions as `Post`, users can access a post's comments by visiting `/post/ID/comments`.

Since this is a [JSONAPI](https://jsonapi.org) endpoint, you will have to supply the proper content headers. Similarly, we support login through headers as well:

<table>
<thead>
  <tr><th>Header</th><th>Value</th></tr>
</thead>
<tr><td>Content-Type</td><td>application/vnd.api+json</td></tr>
<tr><td>Accept</td><td>application/vnd.api+json</td></tr>
<tr><td>User<strong>*</strong></td><td>&lt;your username&gt;</td></tr>
<tr><td>Password<strong>*</strong></td><td>&lt;your password&gt;</td></tr>
</table>

__* Only required if performing an action as logged in user__

### <a name="using-user"></a>Creating a User

#### GraphQL

```
$ curl -X POST \
    http://127.0.0.1:5050/graphql/api/v1 \
    -H 'accept: application/json' \
    -H 'content-type: application/json' \
    -d '{
        "query": "mutation { account(op:UPSERT, data:{name:\"user1\", newPassword:\"123\"}) { edges { node { id name } } } }"
    }
'
```

#### JSON-API

```
$ curl -X POST \
    http://127.0.0.1:5050/api/v1/account \
    -H 'accept: application/vnd.api+json' \
    -H 'content-type: application/vnd.api+json' \
    -d '{
    "data": {
      "type": "account",
      "id": 1,
      "attributes": {
        "name": "user1",
        "newPassword": "123"
      }
    }
  }'
```

### <a name="using-post"></a>Creating a Post

#### GraphQL

```
curl -X POST \
    http://127.0.0.1:5050/graphql/api/v1 \
    -H 'accept: application/json' \
    -H 'content-type: application/json' \
    -H 'password: 123' \
    -H 'user: user1' \
    -d '{
         "query": "mutation { post(op:UPSERT, data:{content:\"This is my very first post!!!\", owner:{id:\"1\"}}) { edges { node { id content owner { edges { node { id } } } } } } }"
     }
'
```

#### JSON-API

```
$ curl -X POST \
    http://127.0.0.1:5050/api/v1/post \
    -H 'accept: application/vnd.api+json' \
    -H 'content-type: application/vnd.api+json' \
    -H 'password: 123' \
    -H 'user: user1' \
    -d '{
    "data": {
      "type": "post",
      "id": 1,
      "attributes": {
        "content": "This is my very first post!!!"
      },
      "relationships": {
        "owner": {
          "data": { "type": "account", "id": "1" }
        }
      }
    }
  }'
```

### <a name="using-comment"></a>Creating a Comment

#### GraphQL

```
curl -X POST \
    http://127.0.0.1:5050/graphql/api/v1 \
    -H 'accept: application/json' \
    -H 'content-type: application/json' \
    -H 'password: 123' \
    -H 'user: user1' \
    -d '{
        "query": "mutation { post(ids: \"1\") { edges { node { comments(op:UPSERT, data:{content:\"This is my first comment. It is very nice!\", owner:{id:\"1\"}}) { edges { node { id content owner { edges { node { id } } } } } } } } } }"
    }
'
```

#### JSON-API

```
$ curl -X POST \
  http://127.0.0.1:5050/api/v1/post/1/comments \
  -H 'accept: application/vnd.api+json' \
  -H 'content-type: application/vnd.api+json' \
  -H 'password: 123' \
  -H 'user: user1' \
  -d '{
  "data": {
    "type": "comment",
    "id": 1,
    "attributes": {
      "content": "This is my first comment. It is very nice!"
    },
    "relationships": {
      "owner": {
        "data": { "type": "account", "id": "1" }
      }
    }
  }
}'
```

### <a name="using-comment"></a>Query Posts with Comments

#### GraphQL

```
$ curl -X POST \
    http://127.0.0.1:5050/graphql/api/v1 \
    -H 'accept: application/json' \
    -H 'content-type: application/json' \
    -d '{
    "query" : "{ post { edges { node { id content comments { edges { node { id content } } } } } } }" 
}'
```

#### JSON-API

```
$ curl -X GET http://127.0.0.1:5050/api/v1/post?include=comments | python -m json.tool
```

